# Live Preview Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           FRONTEND (React Dashboard)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                       PreviewCard Component                       │        │
│  ├─────────────────────────────────────────────────────────────────┤        │
│  │                                                                   │        │
│  │  ┌──────────────┐         ┌──────────────────────────┐          │        │
│  │  │  Mode Tabs   │         │   HMR Status Indicator    │          │        │
│  │  ├──────────────┤         ├──────────────────────────┤          │        │
│  │  │ [Browser]    │         │  🟢 HMR stable · 142ms   │          │        │
│  │  │  CLI         │         │  🟡 HMR building...       │          │        │
│  │  │  Plots       │         │  🔴 HMR error            │          │        │
│  │  │  Tests       │         │  (offline) [disconnected] │          │        │
│  │  │  Docs        │         └──────────────────────────┘          │        │
│  │  └──────────────┘                                                │        │
│  │                                                                   │        │
│  │  ┌───────────────────────────────────────────────────────┐      │        │
│  │  │                   Sandboxed Iframe                     │      │        │
│  │  │  key={iframeKey}  ← Changes to force reload           │      │        │
│  │  │  src={state.url}                                       │      │        │
│  │  │  sandbox="allow-scripts allow-same-origin"             │      │        │
│  │  │                                                         │      │        │
│  │  │  ┌────────────────────────────────────────┐           │      │        │
│  │  │  │   http://localhost:5173                 │           │      │        │
│  │  │  │   (Your Vite/Next.js Dev Server)        │           │      │        │
│  │  │  └────────────────────────────────────────┘           │      │        │
│  │  └───────────────────────────────────────────────────────┘      │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                   ▲                                           │
│                                   │ Updates iframeKey                         │
│  ┌────────────────────────────────┴────────────────────────────────┐        │
│  │               usePreviewStream Hook                              │        │
│  ├──────────────────────────────────────────────────────────────────┤        │
│  │  • Listens to WebSocket events                                   │        │
│  │  • Manages iframeKey (changes on update)                         │        │
│  │  • Tracks buildStatus: idle/compiling/ready/error                │        │
│  │  • Returns: { iframeKey, buildStatus, isConnected, ... }         │        │
│  └──────────────────────────────────────────────────────────────────┘        │
│                                   ▲                                           │
│                                   │ WebSocket Messages                        │
│  ┌────────────────────────────────┴────────────────────────────────┐        │
│  │                    wsClient (WebSocket Client)                   │        │
│  ├──────────────────────────────────────────────────────────────────┤        │
│  │  ws://localhost:3001/ws                                          │        │
│  │  • Auto-reconnect with exponential backoff                       │        │
│  │  • Heartbeat (ping/pong) every 30s                               │        │
│  │  • Message routing by type                                       │        │
│  └──────────────────────────────────────────────────────────────────┘        │
│                                                                               │
└───────────────────────────────────┬───────────────────────────────────────────┘
                                    │
                          WebSocket Connection
                          (Real-time Events)
                                    │
┌───────────────────────────────────▼───────────────────────────────────────────┐
│                          BACKEND (Express + WebSocket)                         │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐        │
│  │                   WebSocket Server (ws://.../ws)                  │        │
│  ├──────────────────────────────────────────────────────────────────┤        │
│  │  Broadcasts events:                                               │        │
│  │  • preview:update      → { url, hmr, timestamp }                 │        │
│  │  • preview:build-start → { status: 'compiling', timestamp }      │        │
│  │  • preview:build-end   → { status: 'ready', durationMs, url }    │        │
│  │  • file:change         → { changeType, files[], count }          │        │
│  └──────────────────────────────────────────────────────────────────┘        │
│                      ▲                              ▲                          │
│                      │                              │                          │
│         Emits events │                              │ Emits events             │
│  ┌───────────────────┴──────────┐   ┌──────────────┴──────────────┐          │
│  │   FileWatcherService         │   │   DevServerService           │          │
│  ├──────────────────────────────┤   ├─────────────────────────────┤          │
│  │  • Watches workspace/ with   │   │  • Tracks build status       │          │
│  │    chokidar                  │   │  • Records build duration    │          │
│  │  • Debounces changes (500ms) │   │  • Provides HMR status       │          │
│  │  • Ignores node_modules/,    │   │  • Simulates rebuild process │          │
│  │    dist/, .git/, etc.        │   │  • state: { url, status,     │          │
│  │  • Emits: file:change,       │   │           lastBuildMs, ... } │          │
│  │    build-start, build-end    │   │                              │          │
│  └──────────────┬───────────────┘   └──────────────────────────────┘          │
│                 │ Watches                                                      │
│                 ▼                                                              │
│  ┌──────────────────────────────────────────────────────────────────┐        │
│  │              Workspace Directory (backend/workspace/)              │        │
│  ├──────────────────────────────────────────────────────────────────┤        │
│  │  src/                                                              │        │
│  │  ├── App.tsx         ← User edits this                            │        │
│  │  ├── components/                                                  │        │
│  │  └── utils/                                                        │        │
│  │  package.json                                                      │        │
│  │  vite.config.ts                                                    │        │
│  └──────────────────────────────────────────────────────────────────┘        │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐        │
│  │               Preview REST API (/v1/preview)                      │        │
│  ├──────────────────────────────────────────────────────────────────┤        │
│  │  GET  /v1/preview/state?mode=browser                              │        │
│  │       → Returns { mode, url, hmr, buildStatus, lastBuildTime }   │        │
│  │                                                                    │        │
│  │  POST /v1/preview/rebuild                                         │        │
│  │       → Triggers manual rebuild, returns new state                │        │
│  └──────────────────────────────────────────────────────────────────┘        │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐        │
│  │              Fallback Polling (10s interval)                      │        │
│  ├──────────────────────────────────────────────────────────────────┤        │
│  │  Frontend calls /v1/preview/state every 10 seconds               │        │
│  │  Only used when WebSocket disconnected or unavailable            │        │
│  └──────────────────────────────────────────────────────────────────┘        │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                              EVENT FLOW DIAGRAM
═══════════════════════════════════════════════════════════════════════════════

┌──────────┐
│   User   │  Saves file (Ctrl+S)
│  Edits   │
│   Code   │
└────┬─────┘
     │
     ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. File System Event                                            │
│     workspace/src/App.tsx changed                                │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. Chokidar Detects Change                                      │
│     FileWatcherService receives 'change' event                   │
│     ├─ Debounce timer starts (500ms)                             │
│     └─ Wait for more changes...                                  │
└─────────────────┬───────────────────────────────────────────────┘
                  │ 500ms later
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. Emit file:change Event                                       │
│     WebSocket broadcast to all clients                           │
│     {                                                             │
│       type: 'file:change',                                       │
│       data: {                                                     │
│         changeType: 'change',                                    │
│         files: ['src/App.tsx'],                                  │
│         count: 1,                                                 │
│         timestamp: '2025-10-22T14:30:00.000Z'                    │
│       }                                                           │
│     }                                                             │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. Start Build Process                                          │
│     DevServerService.startBuild()                                │
│     ├─ Set buildStatus = 'compiling'                             │
│     └─ Emit preview:build-start                                  │
│        {                                                          │
│          type: 'preview:build-start',                            │
│          data: { timestamp: '...', status: 'compiling' }        │
│        }                                                          │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. Frontend Receives build-start                                │
│     usePreviewStream hook:                                       │
│     ├─ setBuildStatus('compiling')                               │
│     └─ UI shows: 🟡 Yellow dot + "HMR building"                 │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  │ ~1 second (simulated build)
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. Build Completes                                              │
│     DevServerService.completeBuild(true)                         │
│     ├─ Set buildStatus = 'ready'                                 │
│     ├─ Record duration = 1024ms                                  │
│     └─ Emit preview:build-end                                    │
│        {                                                          │
│          type: 'preview:build-end',                              │
│          data: {                                                  │
│            status: 'ready',                                       │
│            durationMs: 1024,                                      │
│            url: 'http://localhost:5173',                         │
│            timestamp: '2025-10-22T14:30:01.024Z'                 │
│          }                                                        │
│        }                                                          │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. Frontend Receives build-end                                  │
│     usePreviewStream hook:                                       │
│     ├─ setBuildStatus('ready')                                   │
│     ├─ setIframeKey(Date.now())  ← KEY CHANGES HERE!            │
│     └─ UI shows: 🟢 Green dot + "HMR stable · 1024ms"           │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. React Re-renders PreviewCard                                 │
│     <iframe key={1730467801024} src="http://localhost:5173" />  │
│     └─ New key forces React to unmount & remount iframe          │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│  9. Browser Reloads Iframe                                       │
│     Fetches fresh content from http://localhost:5173            │
│     User sees updated code in preview! ✅                        │
└─────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                           TIMING & PERFORMANCE
═══════════════════════════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────────────┐
│  File Save to UI Update Timeline                                 │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  0ms     ████  User presses Ctrl+S                               │
│  10ms    ████  Chokidar detects change                           │
│  510ms   ████  Debounce completes → file:change emitted          │
│  520ms   ████  Frontend receives event                           │
│  522ms   ████  preview:build-start emitted                       │
│  525ms   ████  Yellow dot appears ("HMR building")               │
│                                                                   │
│          ... build process (simulated ~1000ms) ...               │
│                                                                   │
│  1522ms  ████  preview:build-end emitted                         │
│  1525ms  ████  iframeKey changes                                 │
│  1527ms  ████  Green dot appears ("HMR stable")                  │
│  1530ms  ████  Iframe starts reloading                           │
│  1680ms  ████  New content visible to user                       │
│                                                                   │
│  Total: ~1.68 seconds from save to updated preview               │
└──────────────────────────────────────────────────────────────────┘

Breakdown:
- Debounce delay:        500ms  (batches rapid changes)
- WebSocket latency:     ~2ms   (negligible)
- Build simulation:      1000ms (real Vite builds: 100-500ms)
- Iframe reload:         ~150ms (browser rendering)

═══════════════════════════════════════════════════════════════════════════════
```
